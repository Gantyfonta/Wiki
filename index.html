<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Infinite Wiki</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kosugi&display=swap" rel="stylesheet">
    <style>
      @keyframes blink {
        from, to { opacity: 1 }
        50% { opacity: 0; }
      }
      @keyframes skeleton-glow {
        from { background-color: #e0e0e0; }
        to { background-color: #f0f0f0; }
      }

      body {
        background-color: #ffffff;
        color: #000000;
        font-family: 'Kosugi', sans-serif;
        font-size: 1.1rem; /* Set base font size for the entire app */
        line-height: 1.6; /* Set base line height for readability */
        margin: 0;
        padding: 2rem 2rem 5rem 2rem; /* Increased bottom padding for sticky footer */
      }
      #root {
        max-width: 65ch; /* Optimal line length for readability */
        margin: auto;
      }
      h1, h2, h3, h4, h5, h6 {
        font-size: 1em; /* 1em equals the parent font-size, which is 1.1rem from body */
        margin: 0;
        font-weight: normal; /* Ensure no bolding by default */
      }
      button {
        background: none;
        border: none;
        padding: 0;
        font: inherit;
        color: inherit;
        cursor: pointer;
      }
      .interactive-word {
        color: #000000;
        text-decoration: none;
        transition: color 0.2s ease-in-out;
      }
      .interactive-word:hover {
        color: #0000ff;
        text-decoration: underline;
      }
      .footer-text {
        font-size: 0.9em;
        color: #888;
      }
      .footer-text a {
        color: inherit;
        text-decoration: none;
        transition: color 0.2s ease-in-out;
      }
      .footer-text a:hover {
        color: #0000ff;
        text-decoration: underline;
      }
      .blinking-cursor {
        animation: blink 1s step-end infinite;
      }
      .search-container {
        display: flex;
        align-items: baseline;
        gap: 1rem;
        margin-bottom: 3rem;
      }
      .search-form {
        flex-grow: 1;
      }
      .search-input {
        width: 100%;
        padding: 0.5rem 0.2rem;
        font: inherit;
        color: inherit;
        border: none;
        border-bottom: 1px solid transparent;
        background-color: transparent;
        box-sizing: border-box;
        outline: none;
      }
      .search-input:disabled {
        color: #ccc;
      }
      .search-input::placeholder {
        color: #000000;
        opacity: 1;
      }
      .random-button {
        background: none;
        border: none;
        padding: 0.5rem 0;
        font: inherit;
        color: #000000;
        cursor: pointer;
        white-space: nowrap;
      }
      .random-button:hover:not(:disabled) {
        color: #0000ff;
      }
      .random-button:disabled {
        color: #ccc;
        cursor: not-allowed;
      }
      .sticky-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        text-align: center;
        padding: 1.5rem 0;
        background-color: #ffffff;
      }
      .skeleton-bar {
        height: 1rem;
        margin-bottom: 0.75rem;
        animation: skeleton-glow 1.5s ease-in-out infinite alternate;
      }
      .search-results-container {
        margin-top: 2.5rem;
        border-top: 1px solid #e0e0e0;
        padding-top: 2rem;
      }
      .search-results-heading {
        font-size: 0.8em;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 1.5rem;
        font-weight: 600;
      }
      .search-result {
        margin-bottom: 1.5rem;
      }
      .search-result-link {
        display: block;
        font-size: 1em;
        color: #0000ff;
        text-decoration: none;
        margin-bottom: 0.25rem;
      }
      .search-result-link:hover {
        text-decoration: underline;
      }
      .search-result-uri {
        font-size: 0.8em;
        color: #888;
        word-break: break-all;
        margin: 0;
      }
      .more-button {
        border: 1px solid #888;
        padding: 0.5rem 1.5rem;
        border-radius: 2rem;
        transition: background-color 0.2s, color 0.2s;
        color: #888;
      }
      .more-button:hover:not(:disabled) {
        background-color: #000;
        color: #fff;
        border-color: #000;
      }
      .more-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.7.0"
  }
}
</script>
</head>
<body>
    <div id="root" style="display: none;">
        <header style="text-align: center; margin-bottom: 2rem;">
            <h1 style="letter-spacing: 0.2em; text-transform: uppercase;">INFINITE WIKI</h1>
        </header>

        <div class="search-container">
            <form id="search-form" class="search-form" role="search">
                <input type="text" id="search-input" placeholder="Search" class="search-input" aria-label="Search for a topic">
            </form>
            <button id="random-button" class="random-button">Random</button>
        </div>
        
        <main>
            <div>
                <h2 id="topic-title" style="margin-bottom: 2rem; text-transform: capitalize;"></h2>
                <div id="error-display" style="display: none; border: 1px solid #cc0000; padding: 1rem; color: #cc0000;">
                  <p style="margin: 0;">An Error Occurred</p>
                  <p id="error-message" style="margin-top: 0.5rem; margin: 0;"></p>
                </div>
                <div id="content-display">
                    <!-- Content or skeleton loader goes here -->
                </div>
                <div id="more-button-container" style="text-align: center; margin: 2rem 0; display: none;">
                    <button id="more-button" class="more-button">More</button>
                </div>
                <div id="search-results-container" style="display: none;"></div>
            </div>
        </main>
    
        <footer class="sticky-footer">
            <p class="footer-text" style="margin: 0;">
                Infinite Wiki by <a href="https://x.com/dev_valladares" target="_blank" rel="noopener noreferrer">Dev Valladares</a> · Generated by Gemini
                <span id="generation-time"></span>
            </p>
        </footer>
    </div>
    <script type="module">
        import { GoogleGenAI } from '@google/genai';

        // --- 1. CONFIGURATION & CONSTANTS ---
        let API_KEY = '__GEMINI_API_KEY__'; // This is replaced by the GitHub Action workflow
        const PREDEFINED_WORDS = ['Balance', 'Harmony', 'Discord', 'Unity', 'Fragmentation', 'Clarity', 'Ambiguity', 'Presence', 'Absence', 'Creation', 'Destruction', 'Light', 'Shadow', 'Beginning', 'Ending', 'Rising', 'Falling', 'Connection', 'Isolation', 'Hope', 'Despair', 'Order and chaos', 'Light and shadow', 'Sound and silence', 'Form and formlessness', 'Being and nonbeing', 'Presence and absence', 'Motion and stillness', 'Unity and multiplicity', 'Finite and infinite', 'Sacred and profane', 'Memory and forgetting', 'Question and answer', 'Search and discovery', 'Journey and destination', 'Dream and reality', 'Time and eternity', 'Self and other', 'Known and unknown', 'Spoken and unspoken', 'Visible and invisible', 'Zigzag', 'Waves', 'Spiral', 'Bounce', 'Slant', 'Drip', 'Stretch', 'Squeeze', 'Float', 'Fall', 'Spin', 'Melt', 'Rise', 'Twist', 'Explode', 'Stack', 'Mirror', 'Echo', 'Vibrate', 'Gravity', 'Friction', 'Momentum', 'Inertia', 'Turbulence', 'Pressure', 'Tension', 'Oscillate', 'Fractal', 'Quantum', 'Entropy', 'Vortex', 'Resonance', 'Equilibrium', 'Centrifuge', 'Elastic', 'Viscous', 'Refract', 'Diffuse', 'Cascade', 'Levitate', 'Magnetize', 'Polarize', 'Accelerate', 'Compress', 'Undulate', 'Liminal', 'Ephemeral', 'Paradox', 'Zeitgeist', 'Metamorphosis', 'Synesthesia', 'Recursion', 'Emergence', 'Dialectic', 'Apophenia', 'Limbo', 'Flux', 'Sublime', 'Uncanny', 'Palimpsest', 'Chimera', 'Void', 'Transcend', 'Ineffable', 'Qualia', 'Gestalt', 'Simulacra', 'Abyssal', 'Existential', 'Nihilism', 'Solipsism', 'Phenomenology', 'Hermeneutics', 'Deconstruction', 'Postmodern', 'Absurdism', 'Catharsis', 'Epiphany', 'Melancholy', 'Nostalgia', 'Longing', 'Reverie', 'Pathos', 'Ethos', 'Logos', 'Mythos', 'Anamnesis', 'Intertextuality', 'Metafiction', 'Stream', 'Lacuna', 'Caesura', 'Enjambment'];
        const UNIQUE_WORDS = [...new Set(PREDEFINED_WORDS)];

        let ai;
        const textModelName = 'gemini-2.5-flash';

        // --- 2. DOM ELEMENT REFERENCES ---
        const rootContainer = document.getElementById('root');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const randomButton = document.getElementById('random-button');
        const topicTitle = document.getElementById('topic-title');
        const contentDisplay = document.getElementById('content-display');
        const moreButtonContainer = document.getElementById('more-button-container');
        const moreButton = document.getElementById('more-button');
        const searchResultsContainer = document.getElementById('search-results-container');
        const errorDisplay = document.getElementById('error-display');
        const errorMessageEl = document.getElementById('error-message');
        const generationTimeSpan = document.getElementById('generation-time');

        // --- 3. STATE MANAGEMENT ---
        let currentTopic = '';
        let isLoading = false;
        let generationStartTime;

        // --- 4. GEMINI SERVICE FUNCTIONS ---
        async function generateDefinitionAndSearchResults(topic) {
            if (!ai) throw new Error('Gemini AI is not initialized.');
            const prompt = `Provide a concise, single-paragraph encyclopedia-style definition for the term: "${topic}". Be informative and neutral. Do not use markdown, titles, or any special formatting. Respond with only the text of the definition itself.`;
            
            try {
                const response = await ai.models.generateContent({
                    model: textModelName,
                    contents: prompt,
                    config: {
                        tools: [{googleSearch: {}}],
                    },
                });

                return {
                    definition: response.text,
                    searchResults: response.candidates?.[0]?.groundingMetadata?.groundingChunks ?? [],
                };
            } catch (error) {
                console.error(`Error generating content for "${topic}":`, error);
                throw new Error(`Failed to generate content. ${error.message}`);
            }
        }

        async function generateMoreInfo(topic) {
            if (!ai) throw new Error('Gemini AI is not initialized.');
            const prompt = `Provide a more detailed, multi-paragraph explanation for the term: "${topic}". Expand on its history, significance, and different facets. Be informative and neutral. Do not use markdown, titles, or any special formatting. Respond with only the text of the explanation itself.`;

            const response = await ai.models.generateContent({
                model: textModelName,
                contents: prompt,
            });

            return response.text;
        }


        // --- 5. UI UPDATE FUNCTIONS ---
        function toggleLoading(loading) {
            isLoading = loading;
            searchInput.disabled = loading;
            randomButton.disabled = loading;
            moreButton.disabled = loading;
        }

        function displayContent(fullContent) {
            contentDisplay.innerHTML = '';
            const p = document.createElement('p');
            p.style.margin = 0;

            const words = fullContent.split(/(\s+)/);
            words.forEach(word => {
                if (/\S/.test(word)) {
                    const cleanWord = word.replace(/[.,!?;:()"']/g, '');
                    if (cleanWord) {
                        const button = document.createElement('button');
                        button.textContent = word;
                        button.className = 'interactive-word';
                        button.setAttribute('aria-label', `Learn more about ${cleanWord}`);
                        button.dataset.word = cleanWord;
                        p.appendChild(button);
                    } else {
                        const span = document.createElement('span');
                        span.textContent = word;
                        p.appendChild(span);
                    }
                } else {
                    const span = document.createElement('span');
                    span.textContent = word;
                    p.appendChild(span);
                }
            });
            contentDisplay.appendChild(p);
        }

        function displaySearchResults(results) {
            searchResultsContainer.innerHTML = '';
            searchResultsContainer.style.display = 'none';

            if (!results || results.length === 0) return;

            const validResults = results.filter(r => r.web && r.web.uri && r.web.title);
            if (validResults.length === 0) return;
            
            const topTwoResults = validResults.slice(0, 2);

            const heading = document.createElement('h3');
            heading.className = 'search-results-heading';
            heading.textContent = 'Top Web Results';
            searchResultsContainer.appendChild(heading);
            
            topTwoResults.forEach(resultData => {
                const topResult = resultData.web;
                const item = document.createElement('div');
                item.className = 'search-result';

                const link = document.createElement('a');
                link.className = 'search-result-link';
                link.href = topResult.uri;
                link.textContent = topResult.title;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';

                const uri = document.createElement('p');
                uri.className = 'search-result-uri';
                uri.textContent = topResult.uri;
                
                item.appendChild(link);
                item.appendChild(uri);
                searchResultsContainer.appendChild(item);
            });


            searchResultsContainer.style.display = 'block';
        }

        function renderSkeletonLoader() {
            contentDisplay.innerHTML = ''; // Clear previous content
            for (let i = 0; i < 5; i++) {
                const bar = document.createElement('div');
                bar.className = 'skeleton-bar';
                bar.style.width = `${Math.random() * 40 + 60}%`; // Random widths for realism
                contentDisplay.appendChild(bar);
            }
        }

        function showError(message) {
          errorMessageEl.textContent = message;
          errorDisplay.style.display = 'block';
          contentDisplay.innerHTML = ''; // Clear content/skeleton
        }

        function hideError() {
          errorDisplay.style.display = 'none';
        }

        // --- 6. CORE APPLICATION LOGIC ---
        async function fetchAndDisplayTopic(topic) {
            if (isLoading || !topic || topic.trim() === '') return;

            const normalizedTopic = topic.trim().toLowerCase();
            if (currentTopic === normalizedTopic) return;
            
            toggleLoading(true);
            hideError();
            generationStartTime = Date.now();
            generationTimeSpan.textContent = '';
            currentTopic = normalizedTopic;
            
            searchInput.value = currentTopic;
            topicTitle.textContent = currentTopic;
            window.location.hash = encodeURIComponent(currentTopic);

            renderSkeletonLoader();
            searchResultsContainer.style.display = 'none';
            searchResultsContainer.innerHTML = '';
            moreButtonContainer.style.display = 'none';

            try {
                const contentData = await generateDefinitionAndSearchResults(currentTopic);

                if (contentData.definition && contentData.definition.trim().length > 0) {
                    contentDisplay.innerHTML = ''; // Clear skeleton
                    displayContent(contentData.definition);
                } else {
                    throw new Error("No definition was generated. The topic might be too specific or new.");
                }
                
                displaySearchResults(contentData.searchResults);

                moreButton.disabled = false;
                moreButtonContainer.style.display = 'block';

            } catch (error) {
                console.error("Error fetching topic:", error);
                const userFriendlyMessage = error.message.includes('API key') 
                    ? 'API key is invalid or missing. Please check your configuration.'
                    : error.message.includes("No definition")
                    ? error.message
                    : `Failed to load content for "${currentTopic}". Please try another topic.`;
                showError(userFriendlyMessage);
            } finally {
                toggleLoading(false);
                const endTime = Date.now();
                const duration = ((endTime - generationStartTime) / 1000).toFixed(2);
                generationTimeSpan.textContent = ` · ${duration}s`;
            }
        }

        // --- 7. EVENT LISTENERS ---
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const searchTerm = searchInput.value.trim();
            if (searchTerm) {
                fetchAndDisplayTopic(searchTerm);
            }
        });

        randomButton.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * UNIQUE_WORDS.length);
            const randomWord = UNIQUE_WORDS[randomIndex];
            fetchAndDisplayTopic(randomWord);
        });

        contentDisplay.addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('interactive-word')) {
                const word = target.dataset.word;
                if (word) {
                    fetchAndDisplayTopic(word);
                }
            }
        });
        
        moreButton.addEventListener('click', async () => {
            if (isLoading || !currentTopic) return;
            
            moreButton.disabled = true;
            moreButton.textContent = 'Loading...';
            
            try {
                const moreContent = await generateMoreInfo(currentTopic);
                displayContent(moreContent); // This will replace the old content.
                moreButtonContainer.style.display = 'none'; // Hide button after use.
            } catch (error) {
                console.error("Error fetching more info:", error);
                // Maybe show a small error message near the button? For now, just log it.
                moreButton.textContent = 'Error';
            } finally {
                moreButton.disabled = false;
                moreButton.textContent = 'More';
            }
        });


        window.addEventListener('hashchange', () => {
            const newTopic = decodeURIComponent(window.location.hash.substring(1));
            if (newTopic && newTopic !== currentTopic) {
                fetchAndDisplayTopic(newTopic);
            }
        });

        // --- 8. INITIALIZATION ---
        function init() {
            if (API_KEY === '__GEMINI_API_KEY__') {
                const storedKey = sessionStorage.getItem('gemini_api_key');
                if (storedKey) {
                    API_KEY = storedKey;
                } else {
                    const userKey = prompt('Gemini API Key not found. Please enter your key for local development. It will be stored for this session only.');
                    if (userKey) {
                        API_KEY = userKey;
                        sessionStorage.setItem('gemini_api_key', userKey);
                    } else {
                        document.body.innerHTML = '<div style="text-align: center; padding: 2rem;">An API key is required to use this application. Please reload and provide a valid key.</div>';
                        return;
                    }
                }
            }

            try {
                ai = new GoogleGenAI({ apiKey: API_KEY });
            } catch(e) {
                 document.body.innerHTML = `<div style="text-align: center; padding: 2rem;">Failed to initialize Gemini AI. The API key might be invalid. Please check the console for details.</div>`;
                 console.error(e);
                 return;
            }

            rootContainer.style.display = 'block';
            const initialTopic = decodeURIComponent(window.location.hash.substring(1)) || 'serendipity';
            fetchAndDisplayTopic(initialTopic);
        }

        init();
    </script>
</body>
</html>